<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TacTiq Theme Palette - Designer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --bg: #0a0a0a;
            --card-bg: #111;
            --border: rgba(255, 255, 255, 0.1);
            --header-text: #888;
            --accent: #FF9933;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: #ddd;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            min-height: 100vh;
        }

        body::before {
            content: "";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background: url('jdroidxlogo.png') no-repeat center center;
            background-size: contain;
            opacity: 0.3;
            z-index: -1;
            pointer-events: none;
        }

        p {
            color: var(--header-text);
            font-size: 0.8rem;
            margin-bottom: 15px;
        }

        .btn-premium {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: 800;
            font-size: 0.7rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(255, 153, 51, 0.2);
            white-space: nowrap;
        }

        .btn-secondary {
            background: #222;
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: 800;
            font-size: 0.7rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .top-nav {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 8px 30px;
            /* Compacted */
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid var(--border);
            gap: 20px;
            margin-bottom: 15px;
            /* Reduced vertical gap to matrix */
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo-jdroidx {
            filter: drop-shadow(0 0 15px var(--accent));
            transition: 0.3s;
        }

        .theme-select {
            background: #111;
            color: white;
            border: 1px solid var(--accent);
            padding: 5px 15px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            outline: none;
            transition: 0.3s;
        }

        .theme-select:hover {
            background: var(--accent);
        }

        .btn-reset {
            background: #ff4444;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            font-weight: 800;
            font-size: 0.6rem;
            cursor: pointer;
            text-transform: uppercase;
            opacity: 0.5;
        }

        .table-container {
            width: fit-content;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
        }

        table {
            width: max-content;
            border-collapse: collapse;
            text-align: left;
            font-size: 0.8rem;
            /* Restricted width to content only */
        }

        th {
            background: #111;
            color: white;
            text-transform: none;
            /* Changed from uppercase to Title Case friendly */
            font-size: 0.75rem;
            /* Slightly larger for Title Case readability */
            letter-spacing: 0.02em;
            padding: 5px 8px;
            /* Compacted height */
            border-bottom: 2px solid var(--accent);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 30;
        }

        .del-col {
            position: absolute;
            top: 2px;
            right: 2px;
            color: #ff4444;
            cursor: pointer;
            font-size: 0.7rem;
            opacity: 0.1;
            transition: 0.2s;
            padding: 2px 5px;
        }

        th:hover .del-col {
            opacity: 1;
        }

        .sync-indicator {
            font-size: 0.8rem;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 0 auto;
        }

        .sync-indicator.active {
            background: #44ff44;
            color: #000;
            border-color: #44ff44;
            font-weight: 900;
            box-shadow: 0 0 12px rgba(68, 255, 68, 0.4);
        }

        .push-col {
            width: 40px;
            text-align: center;
            background: #111 !important;
            border-right: 1px solid var(--border);
            position: sticky;
            left: 0;
            z-index: 20;
        }

        /* Ensure cross-section headers stay on top of sticky columns */
        th.push-col,
        th.theme-name {
            z-index: 40;
        }

        td {
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: middle;
            white-space: nowrap;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
        }

        .theme-name {
            color: white;
            font-weight: 700;
            background: #1a1a1a !important;
            border-right: 1px solid var(--border);
            position: sticky;
            left: 40px;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            width: 220px;
            min-width: 220px;
            max-width: 220px;
            white-space: normal;
            word-wrap: break-word;
            padding: 8px 12px;
        }

        .proto-col {
            background: #0a0a0a !important;
            border-right: 1px solid var(--border);
            font-family: 'Courier New', monospace;
            font-size: 0.82rem;
            font-weight: 700;
            color: var(--accent);
            padding: 8px 12px;
            text-align: left;
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            white-space: normal;
            word-break: break-all;
            opacity: 1;
        }

        .row-options {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .edit-row,
        .del-row {
            cursor: pointer;
            font-size: 0.85rem;
            opacity: 1;
            /* Forced visible for easier discovery */
            transition: 0.2s;
            padding: 0 2px;
        }

        .edit-row {
            color: var(--accent);
        }

        .del-row {
            color: #ff4444;
        }

        .btn-push {
            background: rgba(255, 153, 51, 0.1);
            color: var(--accent);
            border: 1px solid var(--accent);
            padding: 4px 8px;
            font-size: 0.6rem;
            border-radius: 4px;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
        }

        .btn-push:hover {
            background: var(--accent);
            color: white;
        }

        .btn-push.active {
            background: #44ff44;
            border-color: #44ff44;
            color: #000;
        }

        .color-cell {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .color-cell:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .hex-code {
            font-family: 'Courier New', Courier, monospace;
            font-weight: 600;
            font-size: 0.75rem;
        }

        #suggestion-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 600px;
            max-height: 85vh;
            background: #111;
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            z-index: 3000;
            display: none;
            /* Initial hidden state */
            flex-direction: column;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.9);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2500;
        }

        .suggestion-grid {
            display: grid;
            grid-template-columns: 130px repeat(3, 1fr);
            gap: 6px;
            margin-top: 10px;
        }

        .grid-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 4px;
            color: var(--accent);
            font-weight: 800;
            text-align: center;
            font-size: 0.6rem;
        }

        /* Custom Scrollbar for Modal Content */
        .modal-scroll-area::-webkit-scrollbar {
            width: 10px;
        }

        .modal-scroll-area::-webkit-scrollbar-thumb {
            background: #00ffff !important;
            /* Bright Cyan for visibility */
            border-radius: 10px;
            border: 2px solid #111;
        }

        .modal-scroll-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .modal-scroll-area {
            overflow-y: auto !important;
            scrollbar-width: thin;
            scrollbar-color: #00ffff #222;
        }

        .option-choice {
            background: rgba(255, 255, 255, 0.02);
            padding: 4px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .status-pill {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #44ff44;
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.65rem;
            font-weight: 800;
            display: none;
            z-index: 4000;
        }

        .selection-radio {
            transform: scale(1.2);
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="top-nav" style="display: flex; gap: 25px; align-items: center; padding: 5px 25px;">
        <!-- Column 1: Fit-to-size Logo -->
        <div style="flex-shrink: 0;">
            <img src="jdroidxlogo.png" alt="jDroid-X Logo" class="logo-jdroidx"
                style="display: block; height: 80px; width: auto; margin: 0;">
        </div>

        <!-- Column 2: Atmosphere Synchronization (2 Rows) -->
        <div
            style="display: flex; flex-direction: column; gap: 3px; border-right: 1px solid rgba(255,255,255,0.1); padding-right: 25px;">
            <span
                style="font-size: 0.85rem; font-weight: 800; color: #aaa; text-transform: uppercase; letter-spacing: 0.05em; white-space: nowrap;">Atmosphere
                Sync:</span>
            <select id="theme-selector" class="theme-select" style="width: 160px; padding: 3px 8px; font-size: 0.75rem;"
                onchange="applyThemeToDesigner(this.value)">
                <option value="-1">Base Designer Theme</option>
            </select>
        </div>

        <!-- Column 3: Design Identity & Action Control (2 Rows) -->
        <div style="flex-grow: 1; display: flex; flex-direction: column; gap: 8px;">
            <!-- Row 1: System Branding -->
            <div style="display: flex; align-items: baseline; gap: 15px;">
                <h1 style="margin: 0; font-size: 1.1rem; letter-spacing: -0.01em; color: white;">Jdroid-X Theme Palette
                    Design System</h1>
                <p
                    style="margin: 0; font-size: 0.55rem; opacity: 0.6; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent); font-weight: 700;">
                    Atmospheric Theme Designer | <span id="active-protocol-badge"
                        style="color: #44ff44; background: rgba(68,255,68,0.1); padding: 1px 6px; border-radius: 4px;">Standalone
                        Mode</span>
                </p>
            </div>

            <!-- Row 2: Action Control Matrix -->
            <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px; width: 100%;">
                <button class="btn-premium" style="padding: 5px 12px; font-size: 0.7rem;"
                    onclick="openThemeDiscovery()">+ Discover Atmosphere</button>
                <button class="btn-secondary" style="padding: 5px 12px; font-size: 0.65rem;" onclick="addNewElement()">+
                    Add UI Layer</button>
                <button class="btn-secondary"
                    style="padding: 5px 12px; font-size: 0.65rem; border-color: #44ff44; color: #44ff44;"
                    onclick="syncToWebsite()">‚Üë
                    Sync To Website</button>
                <button class="btn-secondary"
                    style="padding: 5px 12px; font-size: 0.65rem; border-color: #33aaff; color: #33aaff;"
                    onclick="syncToPalette()">‚Üì
                    Sync To Palette</button>
                <div style="width: 1px; height: 12px; background: rgba(255,255,255,0.1); margin: 0 2px;"></div>
                <button class="btn-secondary" style="font-size: 0.55rem; padding: 5px 10px; opacity: 0.7;"
                    onclick="window.location.href='digital_clone/PDF Stories/index.html'">View Stories</button>
                <button class="btn-reset" style="padding: 5px 10px; font-size: 0.6rem;"
                    onclick="resetData()">Reset</button>
            </div>
        </div>
    </div>

    <div id="status-pill" class="status-pill">CHANGES SAVED</div>
    <div class="table-container">
        <table id="palette-table">
            <thead>
                <tr id="header-row">
                    <th class="push-col">Select</th>
                    <th class="theme-name" style="justify-content:center;">Atmosphere Theme</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <footer
        style="margin-top: 50px; padding: 30px; border-top: 1px solid rgba(255,255,255,0.05); width: 100%; display: flex; justify-content: center;">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
            <p
                style="opacity: 0.8; font-size: 0.9rem; font-weight: 700; letter-spacing: 0.05em; color: white; margin: 0;">
                ¬© 2026 jDroid-X ‚Ä¢ DESIGN SYSTEM MASTER
            </p>
            <span style="font-size: 0.5rem; color: #444; letter-spacing: 0.1em;">BUILD: 2026-02-23 - TACTICAL ARCHITECT
                EDITION V10.0</span>
        </div>
    </footer>

    <div id="modal-overlay" class="modal-overlay" onclick="closeModal()"></div>
    <div id="suggestion-modal" style="display: none;">
        <div
            style="color: white; font-weight: 800; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span id="disc-theme-name" style="font-size: 0.95rem; color: var(--accent);">New Theme</span>
                <div style="font-size: 0.55rem; color: #666; font-weight: 400;">Intelligent matching based on atmosphere
                    keywords</div>
            </div>
            <span
                style="font-size: 0.5rem; color: var(--accent); border: 1px solid var(--accent); padding: 1px 4px; border-radius: 8px;">3-Tier
                Strategy</span>
        </div>

        <!-- Semantic Hue Anchor Bar -->
        <div id="semantic-anchor-container"
            style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; background: rgba(255,255,255,0.03); padding: 4px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);">
            <div id="semantic-hue-bar"
                style="height: 6px; flex: 1; border-radius: 10px; background: linear-gradient(to right, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00); position: relative;">
                <div id="hue-selector-marker"
                    style="position: absolute; top: -4px; width: 14px; height: 14px; background: white; border: 2px solid #000; border-radius: 50%; left: 50%; transform: translateX(-50%); box-shadow: 0 0 10px rgba(0,0,0,0.5);">
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div id="anchor-color-preview"
                    style="width: 12px; height: 12px; border-radius: 2px; background: #fff; border: 1px solid rgba(255,255,255,0.2);">
                </div>
                <span id="anchor-color-name"
                    style="font-size: 0.6rem; color: #888; text-transform: uppercase; font-weight: 700; width: 60px;">Primary
                    Font</span>
            </div>
        </div>

        <div class="modal-scroll-area"
            style="max-height: 50vh; overflow-y: auto; margin-top: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 5px; background: rgba(0,0,0,0.3);">
            <div class="suggestion-grid" style="margin-top: 0;">
                <div class="grid-header"
                    style="text-align: left; position: sticky; top: 0; z-index: 10; background: #222;">
                    UI Element</div>
                <div class="grid-header" style="position: sticky; top: 0; z-index: 10; background: #222;"><input
                        type="radio" name="theme-option" value="1" id="rad-1" class="selection-radio" checked> <label
                        for="rad-1">Old School</label></div>
                <div class="grid-header" style="position: sticky; top: 0; z-index: 10; background: #222;"><input
                        type="radio" name="theme-option" value="2" id="rad-2" class="selection-radio"> <label
                        for="rad-2">New School</label></div>
                <div class="grid-header" style="position: sticky; top: 0; z-index: 10; background: #222;"><input
                        type="radio" name="theme-option" value="3" id="rad-3" class="selection-radio"> <label
                        for="rad-3">Ai
                        GenZ</label></div>
                <div id="dynamic-grid" style="display: contents;"></div>
            </div>
        </div>

        <div style="margin-top: 15px; display: flex; gap: 8px;">
            <button class="btn-premium" style="flex: 1;" onclick="applySuggestedTheme()">Save & Add to Website</button>
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Website Connection Modal -->
    <div id="connect-modal" class="modal-scroll-area"
        style="display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%); width:95%; max-width:500px; max-height: 90vh; overflow-y: auto; background:#111; border:1px solid var(--accent); border-radius:8px; padding:25px; z-index:3000; box-shadow:0 30px 60px rgba(0,0,0,0.9);">
        <h2 style="color:white; margin:0 0 10px 0; font-size:1.2rem;">Connect to Website</h2>
        <p style="font-size:0.75rem; color:#888; margin-bottom:20px;">Enter the relative path or URL of the target
            website `index.html` to discover its 12-Layer UI Structure.</p>

        <input type="text" id="site-url-input" placeholder="e.g. digital_clone/PDF Stories/index.html"
            style="width:100%; padding:12px; background:#000; border:1px solid #333; color:white; border-radius:5px; margin-bottom:15px; font-family:inherit;">

        <div id="connect-feedback"
            style="display:none; color:#ddd; font-size:0.75rem; margin-bottom:15px; background:rgba(255,153,51,0.1); padding:15px; border-radius:8px; line-height:1.4; border:1px solid rgba(255,153,51,0.2);">
        </div>

        <!-- AI Intelligent Bridge -->
        <div id="ai-bridge"
            style="display:none; background:rgba(68,102,255,0.1); padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid rgba(68,102,255,0.2);">
            <p
                style="margin:0; font-size:0.75rem; color:#4466ff; font-weight:800; display:flex; align-items:center; gap:5px;">
                <span style="font-size:1rem;">ü§ñ</span> ANTIGRAVITY AI ASSISTANT
            </p>
            <p style="margin:5px 0 10px 0; font-size:0.65rem; color:#aaa; line-height:1.3;">
                Browsers are restricted, but I am not. Copy this prompt and send it to me in our chat:
            </p>
            <div style="background:#000; padding:10px; border-radius:5px; border:1px solid #333; cursor:pointer;"
                onclick="copyAiPrompt()">
                <code id="ai-prompt-text"
                    style="font-size:0.6rem; color:#44ff44; word-break:break-all;">Please scan the website structure at [URL] and give me the CSS variable block so I can paste it into my Theme Designer.</code>
            </div>
            <p id="copy-status" style="margin:5px 0 0 0; font-size:0.55rem; color:#666; font-style:italic;">Click the
                green text to copy</p>
        </div>

        <div id="fallback-area" style="display:none;">
            <div
                style="background:rgba(0,255,255,0.05); padding:12px; border-radius:8px; margin-bottom:12px; border:1px solid rgba(0,255,255,0.2);">
                <p
                    style="margin:0; font-size:0.75rem; color:#00ffff; font-weight:800; display:flex; align-items:center; gap:8px;">
                    <span style="font-size:1rem;">‚ö°</span> DISCOVERY INTELLIGENCE (No-Code Method)
                </p>
                <p style="margin:8px 0 0 0; font-size:0.65rem; color:#aaa; line-height:1.4;">
                    If you don't know the code, follow this universal bypass:<br><br>
                    1Ô∏è‚É£ <b>Open Website:</b> Open the target site in a new browser tab.<br>
                    2Ô∏è‚É£ <b>Extract Source:</b> Right-Click anywhere ‚Üí <b>"View Page Source"</b> (or Ctrl+U).<br>
                    3Ô∏è‚É£ <b>Mass Copy:</b> Press <b>Ctrl + A</b> (Select All) then <b>Ctrl + C</b> (Copy).<br>
                    4Ô∏è‚É£ <b>Inject:</b> Paste the entire mess below. My AI engine will filter out the junk and find the
                    UI layers for you.
                </p>
            </div>
            <textarea id="manual-code-input"
                placeholder="Paste the giant block of code here... I will find the structure for you."
                style="width:100%; height:100px; background:#000; border:1px solid #333; color:white; border-radius:5px; margin-bottom:10px; padding:10px; font-family:monospace; font-size:0.7rem; resize:none;"></textarea>
            <button class="btn-premium" style="width:100%; margin-bottom:10px;" onclick="processManualContent()">üîç
                Start Intelligent Code Scan</button>
        </div>

        <div style="display:flex; gap:10px;">
            <button id="connect-btn" class="btn-premium" style="flex:1;" onclick="connectToSite()">Connect</button>
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        const defaultThemes = []; // Empty to prevent rendering in table
        const rootThemeIdentity = { name: "Default Theme", key: "default", active: true, locked: true };

        const defaultElements = [
            { name: "Main Body BG", role: "Page Backdrop", colors: [] },
            { name: "Sidebar / UI BG", role: "Navigation Rails", colors: [] },
            { name: "Header and Footer", role: "Structural Bars", colors: [] },
            { name: "Action Buttons", role: "Primary Interaction", colors: [] },
            { name: "Primary Accent", role: "Brand Identity", colors: [] },
            { name: "Secondary Accent", role: "Soft Highlights", colors: [] },
            { name: "Primary Font", role: "Content Body", colors: [] },
            { name: "Highlighted Font", role: "Indicators / Titles", colors: [] },
            { name: "UI Border / Divider", role: "Tactical Grid", colors: [] },
            { name: "Card & Tile BG", role: "Content Modules", colors: [] },
            { name: "Scrollbar & Track", role: "Utility Theming", colors: [] },
            { name: "Success / Alert", role: "Status Feedback", colors: [] },
            { name: "Input & Form BG", role: "Input Surfaces", colors: [] },
            { name: "Modal & Overlay", role: "Pop-up Layers", colors: [] },
            { name: "Dynamic Glow", role: "Aura Effects", colors: [] },
            { name: "Interactive Shadow", role: "Depth Control", colors: [] }
        ];

        let themes = [];
        let elements = [];
        let activeWebsite = "Standalone Mode";
        let pendingOptions = null;

        const semanticPatterns = {
            "Main Body BG": ["bg", "body", "background", "backdrop", "main-bg"],
            "Sidebar / UI BG": ["side", "nav", "ui-bg", "panel", "sidebar"],
            "Header and Footer": ["header", "footer", "top-bar", "bottom-bar", "railing"],
            "Action Buttons": ["btn", "button", "cta", "action", "trigger"],
            "Primary Accent": ["accent", "brand", "primary", "theme"],
            "Secondary Accent": ["soft", "secondary", "sub-accent"],
            "Primary Font": ["text", "font", "body-text", "copy"],
            "Highlighted Font": ["highlight", "title", "gold", "heading"],
            "UI Border / Divider": ["border", "divide", "line", "separator"],
            "Card & Tile BG": ["card", "tile", "box", "module", "container"],
            "Scrollbar & Track": ["scroll", "thumb", "track"],
            "Success / Alert": ["status", "ok", "success", "alert", "warning", "error"],
            "Input & Form BG": ["input", "form", "field", "text-box", "search"],
            "Modal & Overlay": ["modal", "overlay", "popup", "dialog", "mask"],
            "Dynamic Glow": ["glow", "aura", "neon", "bloom"],
            "Interactive Shadow": ["shadow", "drop", "depth", "elevation"]
        };

        function getSemanticGroup(varName) {
            const name = varName.toLowerCase();
            for (const [group, patterns] of Object.entries(semanticPatterns)) {
                if (patterns.some(p => name.includes(p))) return group;
            }
            return null;
        }

        function loadData() {
            const savedThemes = localStorage.getItem('tactiq-matrix-themes');
            const savedElements = localStorage.getItem('tactiq-matrix-elements');
            const savedWebsite = localStorage.getItem('tactiq-active-site');

            if (savedWebsite) {
                activeWebsite = savedWebsite;
                document.getElementById('active-protocol-badge').innerText = activeWebsite;
            }

            if (savedThemes && savedElements) {
                themes = JSON.parse(savedThemes).filter(t => t.key !== 'default');
                elements = JSON.parse(savedElements);

                // Enforce Title Case on all existing data
                themes.forEach(t => t.name = toTitleCase(t.name));
                elements.forEach(e => {
                    e.name = toTitleCase(e.name);
                    if (e.role) e.role = toTitleCase(e.role);
                });
            } else {
                // Initialize with TacTiq Teal (Default) as a starting point
                themes = [
                    { name: "TacTiq Teal (Base)", key: "tactiq-teal", active: true, locked: false }
                ];
                elements = [
                    { name: "Main Body BG", mapping: "main-body-bg", role: "Page Backdrop", colors: ["#174C56"] },
                    { name: "Sidebar / UI BG", mapping: "sidebar-ui-bg", role: "Navigation Rails", colors: ["#0F353C"] },
                    { name: "Header and Footer", mapping: "header-and-footer", role: "Structural Bars", colors: ["#0F353C"] },
                    { name: "Action Buttons", mapping: "action-buttons", role: "Primary Interaction", colors: ["#174C56"] },
                    { name: "Primary Accent", mapping: "primary-accent", role: "Brand Identity", colors: ["#FF9933"] },
                    { name: "Secondary Accent", mapping: "secondary-accent", role: "Soft Highlights", colors: ["#CC7A29"] },
                    { name: "Primary Font", mapping: "primary-font", role: "Content Body", colors: ["#FFFFFF"] },
                    { name: "Highlighted Font", mapping: "highlighted-font", role: "Indicators / Titles", colors: ["#FFD700"] },
                    { name: "UI Border / Divider", mapping: "ui-border-divider", role: "Tactical Grid", colors: ["#FFFFFF1A"] },
                    { name: "Card & Tile BG", mapping: "card-tile-bg", role: "Content Modules", colors: ["#0F353C"] },
                    { name: "Scrollbar & Track", mapping: "scrollbar-track", role: "Utility Theming", colors: ["#FF9933"] },
                    { name: "Success / Alert", mapping: "success-alert", role: "Status Feedback", colors: ["#44FF44"] },
                    { name: "Input & Form BG", mapping: "input-form-bg", role: "Input Surfaces", colors: ["#0000004D"] },
                    { name: "Modal & Overlay", mapping: "modal-overlay", role: "Pop-up Layers", colors: ["#000000CC"] },
                    { name: "Dynamic Glow", mapping: "dynamic-glow", role: "Aura Effects", colors: ["#FF993333"] },
                    { name: "Interactive Shadow", mapping: "interactive-shadow", role: "Depth Control", colors: ["#00000099"] }
                ];
                saveData();
            }

            // Ensure every element has a mapping
            elements.forEach(el => {
                if (!el.mapping) {
                    el.mapping = el.name.toLowerCase().replace(/ \/ /g, '-').replace(/ & /g, '-').replace(/ /g, '-');
                }
            });
        }

        function saveData() { // V9.8 SV
            localStorage.setItem('tactiq-matrix-themes', JSON.stringify(themes));
            localStorage.setItem('tactiq-matrix-elements', JSON.stringify(elements));
            localStorage.setItem('tactiq-active-site', activeWebsite);
            const pill = document.getElementById('status-pill');
            pill.style.display = 'block';
            setTimeout(() => { pill.style.display = 'none'; }, 2000);
        }

        function resetData() {
            if (confirm("Factory Reset? All custom data will be lost.")) {
                localStorage.clear();
                location.reload();
            }
        }

        function renderTable() {
            const headerRow = document.getElementById('header-row');
            const tbody = document.getElementById('table-body');

            // 1. CLEAR AND PREP HEADERS (Themes are now columns)
            headerRow.innerHTML = `
                <th class="push-col">Mapping</th>
                <th class="theme-name" style="justify-content:center; text-align:center; line-height:1.2;">UI Element Layer</th>
                <th class="proto-col" style="text-align:center;">Website Protocol</th>
            `;

            const selector = document.getElementById('theme-selector');
            const currentVal = selector.value;
            selector.innerHTML = '<option value="-1">Base Designer Theme</option>';

            themes.forEach((theme, themeIdx) => {
                const isPinned = theme.active;

                // Populate Dropdown
                const opt = document.createElement('option');
                opt.value = themeIdx;
                opt.innerText = theme.name;
                selector.appendChild(opt);

                let actionIcons = '';
                if (!theme.locked) {
                    actionIcons = `
                        <div class="row-options" style="margin-top:2px;">
                            <span class="edit-row" onclick="renameTheme(${themeIdx})" title="Rename Theme">‚úé</span>
                            <span class="del-row" onclick="deleteTheme(${themeIdx})" title="Delete Theme">√ó</span>
                        </div>
                    `;
                } else {
                    actionIcons = `<div class="row-options" style="margin-top:2px;"><span style="font-size:0.45rem; color:#44ff44; opacity:0.5;">LOCKED</span></div>`;
                }

                const th = document.createElement('th');
                th.style.width = "auto";
                th.style.padding = "4px 12px";
                th.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; gap:3px; padding:4px 0;">
                        <span style="font-size:0.75rem; font-weight:800; color:white;">${theme.name}</span>
                        <button class="btn-push ${isPinned ? 'active' : ''}" onclick="pushTheme(${themeIdx})" style="padding: 2px 6px; font-size: 0.55rem;">
                            ${isPinned ? 'Pinned' : 'Add to Site'}
                        </button>
                        ${actionIcons}
                    </div>
                `;
                headerRow.appendChild(th);
            });

            // 2. RENDER ROWS (Elements are now rows)
            tbody.innerHTML = '';
            const supportedElements = [
                "Main Body BG", "Sidebar / UI BG", "Header and Footer",
                "Action Buttons", "Primary Accent", "Secondary Accent",
                "Primary Font", "Highlighted Font", "UI Border / Divider",
                "Card & Tile BG", "Scrollbar & Track", "Success / Alert",
                "Input & Form BG", "Modal & Overlay", "Dynamic Glow", "Interactive Shadow"
            ];

            const mappingCounts = {};
            elements.forEach(el => {
                if (el.mapping) mappingCounts[el.mapping] = (mappingCounts[el.mapping] || 0) + 1;
            });

            elements.forEach((el, elIdx) => {
                const tr = document.createElement('tr');
                const isSupported = supportedElements.includes(el.name);

                // Cell 1: Mapping Status
                const mappingTd = document.createElement('td');
                mappingTd.className = 'push-col';
                mappingTd.innerHTML = `
                    <div class="sync-indicator active" 
                         onclick="toggleMapping(${elIdx})"
                         title="Link this Designer Layer to Website CSS">
                         ‚úì
                    </div>
                `;
                tr.appendChild(mappingTd);

                // Cell 2: Element Name
                const nameTd = document.createElement('td');
                nameTd.className = 'theme-name';
                const discoveryBadge = el.role === "Discovered Layer" ? `<span style="font-size:0.5rem; color:#666; font-style:italic;">(Discovered)</span>` : '';
                nameTd.innerHTML = `
                    <div style="display:flex; flex-direction:column;">
                        <span style="${el.role === 'Discovered Layer' ? 'opacity:0.7; font-style:italic;' : ''}">${el.name}</span>
                        ${discoveryBadge}
                    </div>
                    <div class="row-options">
                        <span class="edit-row" onclick="editElement(${elIdx})" title="Rename Layer">‚úé</span>
                        <span class="del-row" onclick="deleteElement(${elIdx})" title="Delete Layer">√ó</span>
                    </div>
                `;
                tr.appendChild(nameTd);

                // Cell 3: Website Protocol (Mapping)
                const isDuplicate = mappingCounts[el.mapping] > 1;
                const protoTd = document.createElement('td');
                protoTd.className = 'proto-col';
                if (isDuplicate) {
                    protoTd.style.background = "rgba(255, 68, 68, 0.15)";
                    protoTd.style.borderColor = "#ff4444";
                }
                const siteMarker = activeWebsite !== "Standalone Mode" ? `<div style="font-size:0.5rem; color:#666; font-family:sans-serif; margin-bottom:2px;">[${activeWebsite}]</div>` : '';
                const duplicateFlag = isDuplicate ? `<span style="font-size:0.45rem; color:#ff4444; float:right; font-weight:900;">DUPLICATE MAP</span>` : '';
                protoTd.innerHTML = `${siteMarker}${duplicateFlag}<code>--${el.mapping}</code>`;
                protoTd.onclick = () => {
                    const newMap = prompt(`Enter Website CSS Variable name for "${el.name}":\n(Example: main-body-bg)`, el.mapping);
                    if (newMap) {
                        el.mapping = newMap.replace(/^--/, '');
                        saveData(); renderTable();
                    }
                };
                tr.appendChild(protoTd);

                // Cells 4-N: Colors for each Theme
                themes.forEach((theme, themeIdx) => {
                    const color = el.colors[themeIdx] || "#333333";
                    const td = document.createElement('td');
                    td.style.textAlign = "center";
                    td.innerHTML = `
                        <div class="color-cell" onclick="editColor(${themeIdx}, ${elIdx})" title="Click to change color" style="justify-content:center;">
                            <div class="color-box" style="background: ${color};"></div>
                            <span class="hex-code">${color}</span>
                        </div>
                    `;
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        function editColor(themeIdx, elIdx) {
            const picker = document.createElement('input');
            picker.type = 'color';
            picker.value = elements[elIdx].colors[themeIdx] || "#333333";

            picker.oninput = (e) => {
                const newColor = e.target.value.toUpperCase();
                elements[elIdx].colors[themeIdx] = newColor;

                // Partial render for speed: find every instance of this cell and update
                renderTable();
            };

            picker.onchange = () => {
                saveData(); // Commit to storage
            };

            picker.click();
        }

        function toggleMapping(idx) {
            const supportedElements = [
                "Main Body BG", "Sidebar / UI BG", "Header and Footer",
                "Action Buttons", "Primary Accent", "Secondary Accent",
                "Primary Font", "Highlighted Font", "UI Border / Divider",
                "Card & Tile BG", "Scrollbar & Track", "Success / Alert",
                "Input & Form BG", "Modal & Overlay", "Dynamic Glow", "Interactive Shadow"
            ];
            const el = elements[idx];
            if (supportedElements.includes(el.name)) {
                alert("‚úì COMPOSITE MATCH: This element is already live-mapped to your website's CSS structure.");
                return;
            }

            const choice = prompt(
                `"${el.name}" is a STANDALONE column (not yet controlling visible code).\n\n` +
                `Type a NUMBER (1-16) to map it to the Website's 16-Layer Structure:\n` +
                `1. Main Body BG\n2. Sidebar / UI BG\n3. Header and Footer\n4. Action Buttons\n5. Primary Accent\n6. Secondary Accent\n7. Primary Font\n8. Highlighted Font\n9. UI Border / Divider\n10. Card & Tile BG\n11. Scrollbar & Track\n12. Success / Alert\n13. Input & Form BG\n14. Modal & Overlay\n15. Dynamic Glow\n16. Interactive Shadow`
            );

            if (choice) {
                const map = {
                    "1": "Main Body BG", "2": "Sidebar / UI BG", "3": "Header and Footer",
                    "4": "Action Buttons", "5": "Primary Accent", "6": "Secondary Accent",
                    "7": "Primary Font", "8": "Highlighted Font", "9": "UI Border / Divider",
                    "10": "Card & Tile BG", "11": "Scrollbar & Track", "12": "Success / Alert",
                    "13": "Input & Form BG", "14": "Modal & Overlay", "15": "Dynamic Glow", "16": "Interactive Shadow"
                };
                if (map[choice]) {
                    el.name = map[choice];
                    el.role = "Mapped Core Element";
                    saveData(); renderTable();
                }
            }
        }

        function pushTheme(idx) {
            themes[idx].active = !themes[idx].active;
            saveData();
            renderTable();
            if (themes[idx].active) {
                alert(`"${themes[idx].name}" added to website menu! Close this window to return to PDF Stories.`);
            }
        }

        function renameTheme(idx) {
            const currentName = themes[idx].name;
            const newName = prompt(`Enter a new name for the theme "${currentName}":`, currentName);
            if (newName && newName !== currentName) {
                themes[idx].name = toTitleCase(newName);
                saveData();
                renderTable();
            }
        }

        function syncToWebsite() {
            saveData();

            // ARCHITECTURAL CLOSED LOOP: Generate a complete CSS block for the current active site
            let blueprint = `:root {\n  /* TACTIQ ARCHITECT - LIVE SITE INJECTION: ${activeWebsite} */\n`;
            elements.forEach(el => {
                const activeThemeIdx = themes.findIndex(t => t.active);
                const themeIdx = activeThemeIdx !== -1 ? activeThemeIdx : 0;
                blueprint += `  --${el.mapping}: ${el.colors[themeIdx]};\n`;
            });
            blueprint += `}\n`;

            navigator.clipboard.writeText(blueprint).then(() => {
                alert(`‚úì CLOSED LOOP SYNC COMPLETE\n\n1. Technical Blueprint for "${activeWebsite}" copied to clipboard.\n2. Paste this into your site's :root block to apply the new atmosphere.\n\nNote: The 16-Layer UI matrix is now fully synchronized.`);
            });
        }

        function syncToPalette() {
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('connect-modal').style.display = 'block';
        }

        async function connectToSite() {
            const path = document.getElementById('site-url-input').value.trim();
            const connectBtn = document.getElementById('connect-btn');
            const feedback = document.getElementById('connect-feedback');

            if (!path) {
                alert("Please enter a path or URL.");
                return;
            }

            connectBtn.innerText = "Connecting...";
            feedback.style.display = 'none';

            try {
                const response = await fetch(path);
                if (!response.ok) throw new Error("Could not reach site.");
                const content = await response.text();

                // Determine base path for resolving linked CSS
                let basePath = "";
                if (path.includes('/')) {
                    basePath = path.substring(0, path.lastIndexOf('/') + 1);
                }

                await processStructure(content, basePath, path);
            } catch (err) {
                console.error(err);
                connectBtn.innerText = "Connect";
                feedback.style.display = 'block';
                const siteUrl = path.startsWith('http') ? path : `https://your-site.com/${path}`;
                feedback.innerHTML = `
                    <div style="color:#ff9933; font-weight:800; margin-bottom:5px;">‚ö†Ô∏è CROSS-ORIGIN SECURITY BLOCK</div>
                    Your browser is blocking direct access to <b>${new URL(siteUrl).hostname}</b> for security.
                `;

                // Show the AI Bridge with a custom prompt
                document.getElementById('ai-bridge').style.display = 'block';
                document.getElementById('ai-prompt-text').innerText = `I'm trying to sync my theme. Please scan the website at "${path}" for its 16-Layer UI structure and give me the CSS variable block to paste.`;

                document.getElementById('fallback-area').style.display = 'block';
            }
        }

        async function processManualContent() {
            const code = document.getElementById('manual-code-input').value;
            if (!code) return alert("Please paste code first.");
            await processStructure(code);
        }

        async function processStructure(content, basePath = "", sourceUrl = "") {
            if (sourceUrl) {
                activeWebsite = sourceUrl.includes('/') ? sourceUrl.substring(sourceUrl.lastIndexOf('/') + 1) : sourceUrl;
                if (!activeWebsite) activeWebsite = sourceUrl;
                document.getElementById('active-protocol-badge').innerText = activeWebsite;
            }
            // Updated Regex to find CSS variables: --name: value
            const varRegex = /--([a-zA-Z0-9-]+)\s*:\s*([^;!]+)/g;
            let match;
            let foundCount = 0;
            let newCount = 0;
            const detectedVars = [];

            // 1. Scrape variables from the current content
            while ((match = varRegex.exec(content)) !== null) {
                const varName = match[1];
                const cleanName = toTitleCase(varName.replace(/-/g, ' '));
                if (!detectedVars.find(v => v.raw === varName)) {
                    detectedVars.push({ name: cleanName, raw: varName, value: match[2].trim() });
                }
            }

            // 2. If HTML, follow linked stylesheets
            if (content.includes('<link') && content.includes('stylesheet')) {
                const linkRegex = /<link[^>]+href=["']([^"']+\.css)["']/g;
                let linkMatch;
                while ((linkMatch = linkRegex.exec(content)) !== null) {
                    const cssUrl = linkMatch[1];
                    try {
                        // Resolve relative URL
                        const targetUrl = basePath + cssUrl;
                        const cssResponse = await fetch(targetUrl);
                        if (cssResponse.ok) {
                            const cssContent = await cssResponse.text();
                            varRegex.lastIndex = 0; // Reset regex
                            while ((match = varRegex.exec(cssContent)) !== null) {
                                const varName = match[1];
                                const cleanName = toTitleCase(varName.replace(/-/g, ' '));
                                if (!detectedVars.find(v => v.raw === varName)) {
                                    detectedVars.push({ name: cleanName, raw: varName, value: match[2].trim() });
                                }
                            }
                        }
                    } catch (e) {
                        console.warn("Could not follow stylesheet:", cssUrl);
                    }
                }
            }

            if (detectedVars.length === 0) {
                alert("No UI structure (CSS variables) found. Tip: Point to the .css file instead of .html, or paste your CSS code directly into the box.");
                return;
            }

            detectedVars.forEach(v => {
                // INTELLIGENT GROUPING: Try to match by name OR semantic group
                let existingIdx = elements.findIndex(el => el.name.toLowerCase() === v.name.toLowerCase());

                if (existingIdx === -1) {
                    const groupName = getSemanticGroup(v.raw);
                    if (groupName) {
                        existingIdx = elements.findIndex(el => el.name === groupName);
                    }
                }

                const detectedColor = v.value.startsWith('#') ? v.value : null;

                if (existingIdx !== -1) {
                    foundCount++;
                    elements[existingIdx].mapping = v.raw;
                    if (detectedColor) {
                        for (let i = 0; i < themes.length; i++) {
                            if (elements[existingIdx].role === "Discovered Layer") {
                                elements[existingIdx].colors[i] = detectedColor;
                            }
                        }
                    }
                } else {
                    elements.push({
                        name: v.name,
                        mapping: v.raw,
                        role: "Discovered Layer",
                        colors: new Array(themes.length).fill(detectedColor || "#333333")
                    });
                    newCount++;
                }
            });

            saveData();
            renderTable();
            closeModal();

            const msg = `‚úì ARCHITECTURAL INTEGRATION COMPLETE\n\n` +
                `‚Ä¢ Website: ${activeWebsite}\n` +
                `‚Ä¢ ${foundCount} elements semantically grouped into existing structure.\n` +
                `‚Ä¢ ${newCount} new specific layers discovered.\n\n` +
                `Note: Your Designer is now synchronized with "${activeWebsite}".`;
            alert(msg);
        }

        function deleteTheme(idx) {
            if (confirm(`Delete theme "${themes[idx].name}"?`)) {
                themes.splice(idx, 1);
                elements.forEach(el => el.colors.splice(idx, 1));
                saveData(); renderTable();
            }
        }

        function deleteElement(idx) {
            if (confirm(`Delete UI element "${elements[idx].name}"?`)) {
                elements.splice(idx, 1);
                saveData(); renderTable();
            }
        }

        function editElement(idx) {
            const currentName = elements[idx].name;
            const newName = prompt(`Rename UI Layer "${currentName}":`, currentName);
            if (newName && newName !== currentName) {
                elements[idx].name = toTitleCase(newName);
                saveData(); renderTable();
            }
        }

        let discoveryHue = 0; // Global tracking for manual overrides

        function openThemeDiscovery() {
            let themeName = prompt("Atmosphere name:", "Cyber Oasis");
            if (!themeName) return;
            themeName = toTitleCase(themeName);
            document.getElementById('disc-theme-name').innerText = themeName;

            // 1. Initial Semantic Detection
            const nameLower = themeName.toLowerCase();
            if (nameLower.includes("red")) discoveryHue = 0;
            else if (nameLower.includes("orange")) discoveryHue = 25;
            else if (nameLower.includes("gold") || nameLower.includes("yellow")) discoveryHue = 48;
            else if (nameLower.includes("green")) discoveryHue = 135;
            else if (nameLower.includes("cyan") || nameLower.includes("teal")) discoveryHue = 185;
            else if (nameLower.includes("blue")) discoveryHue = 215;
            else if (nameLower.includes("purple")) discoveryHue = 275;
            else if (nameLower.includes("pink")) discoveryHue = 335;
            else {
                let tempH = 0;
                for (let i = 0; i < nameLower.length; i++) tempH += nameLower.charCodeAt(i);
                discoveryHue = tempH % 360;
            }

            updateDiscoveryGrid(themeName);
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('suggestion-modal').style.display = 'flex';
        }

        function updateDiscoveryGrid(themeName) {
            pendingOptions = {
                baseName: themeName,
                option1: elements.map(el => generateIntelligentColor(themeName, el.name, 1, discoveryHue)),
                option2: elements.map(el => generateIntelligentColor(themeName, el.name, 2, discoveryHue)),
                option3: elements.map(el => generateIntelligentColor(themeName, el.name, 3, discoveryHue))
            };
            const grid = document.getElementById('dynamic-grid');
            grid.innerHTML = '';
            elements.forEach((el, idx) => {
                const label = document.createElement('div');
                label.style.padding = "5px 10px";
                label.innerHTML = `<span style="color:#aaa; font-size:0.7rem;">${el.name}</span>`;
                grid.appendChild(label);
                [pendingOptions.option1[idx], pendingOptions.option2[idx], pendingOptions.option3[idx]].forEach(val => {
                    const box = document.createElement('div');
                    box.className = 'option-choice';
                    box.innerHTML = `<div class="color-box" style="background: ${val}; width: 22px; height: 22px;"></div><span class="hex-code" style="font-size:0.6rem;">${val}</span>`;
                    grid.appendChild(box);
                });
            });

            // Update UI Tracker
            const marker = document.getElementById('hue-selector-marker');
            const preview = document.getElementById('anchor-color-preview');
            const nameLabel = document.getElementById('anchor-color-name');
            marker.style.left = `${(discoveryHue / 360) * 100}%`;
            preview.style.background = `hsl(${discoveryHue}, 100%, 60%)`;
            nameLabel.innerText = themeName.split(' ')[0];
        }

        // Make Hue Bar Interactive
        document.addEventListener('DOMContentLoaded', () => {
            const hueBar = document.getElementById('semantic-hue-bar');
            if (!hueBar) return;

            const handleHueChange = (e) => {
                const rect = hueBar.getBoundingClientRect();
                let x = e.clientX - rect.left;
                x = Math.max(0, Math.min(x, rect.width));
                discoveryHue = Math.round((x / rect.width) * 360);
                const themeName = document.getElementById('disc-theme-name').innerText;
                updateDiscoveryGrid(themeName);
            };

            hueBar.onmousedown = (e) => {
                handleHueChange(e);
                const moveHandler = (me) => handleHueChange(me);
                const upHandler = () => {
                    window.removeEventListener('mousemove', moveHandler);
                    window.removeEventListener('mouseup', upHandler);
                };
                window.addEventListener('mousemove', moveHandler);
                window.addEventListener('mouseup', upHandler);
            };
        });

        function generateIntelligentColor(themeName, elName, variant, manualHue = null) {
            const name = themeName.toLowerCase();
            let baseH = manualHue !== null ? manualHue : 0;
            let isGrey = false;

            // 1. Semantic Keyword Detection (Only if not manually overridden)
            if (manualHue === null) {
                if (name.includes("grey") || name.includes("gray") || name.includes("stock") || name.includes("silver") || name.includes("slate") || name.includes("metal")) {
                    isGrey = true;
                    baseH = 210; // Cool grey base
                }
                else if (name.includes("red") || name.includes("blood") || name.includes("lava")) baseH = 0;
                else if (name.includes("orange") || name.includes("sunset") || name.includes("tiger")) baseH = 25;
                else if (name.includes("gold") || name.includes("yellow") || name.includes("sun")) baseH = 48;
                else if (name.includes("green") || name.includes("emerald") || name.includes("forest")) baseH = 135;
                else if (name.includes("cyan") || name.includes("teal") || name.includes("aqua") || name.includes("ice")) baseH = 185;
                else if (name.includes("blue") || name.includes("ocean") || name.includes("sky")) baseH = 215;
                else if (name.includes("purple") || name.includes("violet") || name.includes("berry")) baseH = 275;
                else if (name.includes("pink") || name.includes("rose") || name.includes("candy")) baseH = 335;
                else {
                    for (let i = 0; i < name.length; i++) baseH += name.charCodeAt(i);
                    baseH = baseH % 360;
                }
            }

            let h = baseH, s = isGrey ? 5 : 70, l = 50;

            // 2. Structural Role Logic & Bracketing (Comprehensive 16-Layer Suite)
            if (elName.includes("Main Body")) { h = (baseH + 5) % 360; s = isGrey ? 2 : 20; l = 10; }
            else if (elName.includes("Sidebar")) { h = (baseH + 10) % 360; s = isGrey ? 3 : 25; l = 7; }
            else if (elName.includes("Header")) { h = baseH; s = isGrey ? 4 : 40; l = 18; }
            else if (elName.includes("Primary Font")) { s = isGrey ? 0 : 70; l = 92; }
            else if (elName.includes("Button")) { h = baseH; s = isGrey ? 8 : 45; l = 28; }
            else if (elName.includes("Accent")) { h = baseH; s = isGrey ? 15 : 100; l = 60; }
            else if (elName.includes("Secondary Accent")) { h = (baseH + 20) % 360; s = isGrey ? 5 : 50; l = 40; }
            else if (elName.includes("Highlighted")) { h = 45; s = 90; l = 75; }
            else if (elName.includes("Border")) { h = baseH; s = isGrey ? 2 : 15; l = 25; }
            else if (elName.includes("Card")) { h = (baseH + 5) % 360; s = isGrey ? 4 : 22; l = 14; }
            else if (elName.includes("Scrollbar")) { h = baseH; s = isGrey ? 0 : 20; l = 35; }
            else if (elName.includes("Success")) { h = 140; s = 80; l = 45; }
            else if (elName.includes("Input & Form")) { h = baseH; s = isGrey ? 5 : 15; l = 5; }
            else if (elName.includes("Modal & Overlay")) { h = baseH; s = isGrey ? 5 : 10; l = 2; }
            else if (elName.includes("Dynamic Glow")) { h = baseH; s = 100; l = 60; }
            else if (elName.includes("Interactive Shadow")) { h = baseH; s = 10; l = 5; }

            // 3. Generation Era Logic
            if (variant === 1) { // Old School (Dull / Analog / 70s-90s)
                if (isGrey) {
                    s = 2;
                    if (elName.includes("Accent")) { l = 45; s = 8; }
                    else if (elName.includes("Primary Font")) { l = 70; s = 0; }
                    else if (elName.includes("Button")) { l = 35; }
                } else {
                    s = Math.max(10, s - 30);
                    if (elName.includes("Main Body")) l = 12;
                    else if (elName.includes("Accent")) l = 45;
                }
            }
            else if (variant === 2) { // New School (Glossy / Vibrant / 2020s)
                if (isGrey) {
                    s = 15; h = 215; // Cool Chrome
                    if (elName.includes("Accent")) l = 85;
                    else if (elName.includes("Button")) l = 45;
                    else if (elName.includes("Main Body")) l = 8;
                } else {
                    s = 100; // Max Sensation
                    if (elName.includes("Main Body")) l = 10;
                    else if (elName.includes("Accent")) { l = 65; s = 100; }
                    else if (elName.includes("Button")) { l = 40; h = (baseH - 10) % 360; }
                }
            }
            else { // Ai GenZ (Synthetic / Neon / Futuristic)
                if (isGrey) {
                    if (elName.includes("Main Body")) l = 2;
                    else if (elName.includes("Sidebar")) l = 4;
                    else if (elName.includes("Accent")) { l = 95; s = 0; }
                    else if (elName.includes("Header")) { l = 15; }
                    else if (elName.includes("Button")) { l = 30; }
                } else {
                    s = 100;
                    h = (baseH + 35) % 360;
                    if (elName.includes("Main Body")) { l = 3; h = (baseH + 200) % 360; s = 40; }
                    else if (elName.includes("Sidebar")) { l = 6; h = (baseH + 200) % 360; s = 30; }
                    else if (elName.includes("Header")) { l = 10; h = (baseH + 200) % 360; s = 50; }
                    else if (elName.includes("Accent")) { l = 60; s = 100; h = (baseH + 35) % 360; }
                    else if (elName.includes("Button")) { l = 35; h = (baseH + 75) % 360; s = 80; }
                    else if (elName.includes("Primary Font")) { l = 96; s = 50; h = (baseH + 20) % 360; }
                }
            }

            return hslToHex(h, s, l);
        }

        function toTitleCase(str) {
            if (!str) return "";
            return str.split(' ').map(word => {
                if (!word) return "";
                if (word.startsWith('(')) return '(' + toTitleCase(word.slice(1));

                const upper = word.toUpperCase();
                const techTerms = ["BG", "UI", "CSS", "PDF", "API"];
                if (techTerms.includes(upper)) return upper;

                const brands = { "tactiq": "TacTiq", "genz": "GenZ", "stories": "Stories" };
                if (brands[word.toLowerCase()]) return brands[word.toLowerCase()];

                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join(' ');
        }

        function hslToHex(h, s, l) {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
        }

        function applySuggestedTheme() {
            const selectedOptNum = document.querySelector('input[name="theme-option"]:checked').value;
            const chosenColors = pendingOptions[`option${selectedOptNum}`];

            const prefixes = { "1": "Old", "2": "New", "3": "GenZ" };
            const prefix = prefixes[selectedOptNum];
            const fullName = toTitleCase(`${prefix} ${pendingOptions.baseName}`);

            themes.push({ name: fullName, key: fullName.toLowerCase().replace(/\s/g, '-'), active: true });
            elements.forEach((el, idx) => el.colors.push(chosenColors[idx]));
            saveData(); renderTable(); closeModal();
            alert(`"${fullName}" created and added to website!`);
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('suggestion-modal').style.display = 'none';
            document.getElementById('connect-modal').style.display = 'none';
            document.getElementById('fallback-area').style.display = 'none';
            document.getElementById('connect-feedback').style.display = 'none';
        }

        function addNewElement() {
            const name = prompt("Element Name:"); if (!name) return;
            const role = prompt("Visual Role:"); if (!role) return;
            const formattedName = toTitleCase(name);
            elements.push({ name: formattedName, role: toTitleCase(role), colors: new Array(themes.length).fill("#333333") });
            saveData(); renderTable();
        }

        function exportBlueprint() {
            let blueprint = `/* TACTIQ DESIGN ARCHITECT BLUEPRINT */\n\n`;
            elements.forEach((el, idx) => {
                const varName = el.mapping || el.name.toLowerCase().replace(/ \/ /g, '-').replace(/ & /g, '-').replace(/ /g, '-');
                blueprint += `/* ${el.name} (${el.role}) */\n`;
                themes.forEach((theme, themeIdx) => {
                    blueprint += `--${varName}-${theme.key}: ${el.colors[themeIdx]};\n`;
                });
                blueprint += `\n`;
            });
            navigator.clipboard.writeText(blueprint).then(() => {
                alert("Master Design Blueprint copied to clipboard!\n\nYou can now paste this CSS structure into any new website project.");
            });
        }

        function applyThemeToDesigner(themeIdx) {
            if (themeIdx == -1) {
                // Restore default designer colors
                document.documentElement.style.setProperty('--bg', '#0a0a0a');
                document.documentElement.style.setProperty('--card-bg', '#111');
                document.documentElement.style.setProperty('--accent', '#FF9933');
                return;
            }

            // Map Palette Elements to Designer UI variables
            const theme = themes[themeIdx];

            // Function to find color by element name
            const getColor = (name) => {
                const el = elements.find(e => e.name === name);
                return el ? el.colors[themeIdx] : null;
            };

            const bg = getColor("Main Body BG");
            const cardBg = getColor("Card & Tile BG") || getColor("Sidebar / UI BG");
            const accent = getColor("Primary Accent");

            if (bg) document.documentElement.style.setProperty('--bg', bg);
            if (cardBg) document.documentElement.style.setProperty('--card-bg', cardBg);
            if (accent) document.documentElement.style.setProperty('--accent', accent);
        }

        function copyAiPrompt() {
            const text = document.getElementById('ai-prompt-text').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const status = document.getElementById('copy-status');
                status.innerText = "‚úì Prompt Copied! Paste it in our chat now.";
                status.style.color = "#44ff44";
                setTimeout(() => {
                    status.innerText = "Click the green text to copy";
                    status.style.color = "#666";
                }, 3000);
            });
        }

        window.onload = () => { loadData(); renderTable(); };
    </script>
</body>

</html>