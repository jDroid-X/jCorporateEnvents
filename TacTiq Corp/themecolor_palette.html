<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TacTiq Theme Palette - Designer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a;
            --card-bg: #111;
            --border: rgba(255, 255, 255, 0.1);
            --header-text: #888;
            --accent: #FF9933;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: #ddd;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: white;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 2px;
            font-size: 1.5rem;
        }

        p {
            color: var(--header-text);
            font-size: 0.8rem;
            margin-bottom: 15px;
        }

        .action-bar {
            width: 100%;
            max-width: 1400px;
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            gap: 10px;
        }

        .btn-premium {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: 800;
            font-size: 0.7rem;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(255, 153, 51, 0.2);
            white-space: nowrap;
        }

        .btn-secondary {
            background: #222;
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: 800;
            font-size: 0.7rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .top-nav {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 10px 40px;
            background: rgba(0, 0, 0, 0.5);
            border-bottom: 1px solid var(--border);
            gap: 30px;
            margin-bottom: 30px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .logo-jdroidx {
            height: 35px;
            filter: drop-shadow(0 0 5px var(--accent));
        }

        .theme-selector-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-select {
            background: #111;
            color: white;
            border: 1px solid var(--accent);
            padding: 5px 15px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            outline: none;
            transition: 0.3s;
        }

        .theme-select:hover {
            background: var(--accent);
        }

        .btn-reset {
            background: #ff4444;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            font-weight: 800;
            font-size: 0.6rem;
            cursor: pointer;
            text-transform: uppercase;
            opacity: 0.5;
        }

        .table-container {
            width: fit-content;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
        }

        table {
            width: max-content;
            border-collapse: collapse;
            text-align: left;
            font-size: 0.8rem;
            /* Restricted width to content only */
        }

        th {
            background: #111;
            color: white;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            padding: 5px 8px;
            /* Compacted height */
            border-bottom: 2px solid var(--accent);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 30;
        }

        .del-col {
            position: absolute;
            top: 2px;
            right: 2px;
            color: #ff4444;
            cursor: pointer;
            font-size: 0.7rem;
            opacity: 0.1;
            transition: 0.2s;
            padding: 2px 5px;
        }

        th:hover .del-col {
            opacity: 1;
        }

        .sync-indicator {
            font-size: 0.55rem;
            width: 14px;
            height: 14px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }

        .sync-indicator.active {
            background: #44ff44;
            color: #000;
            border-color: #44ff44;
            font-weight: 900;
            box-shadow: 0 0 8px rgba(68, 255, 68, 0.3);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            vertical-align: middle;
            white-space: nowrap;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
        }

        .theme-name {
            color: white;
            font-weight: 700;
            background: #1a1a1a !important;
            border-right: 1px solid var(--border);
            position: sticky;
            left: 60px;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            min-width: 200px;
        }

        .row-options {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .edit-row,
        .del-row {
            cursor: pointer;
            font-size: 0.85rem;
            opacity: 0.3;
            transition: 0.2s;
            padding: 0 2px;
        }

        .edit-row {
            color: var(--accent);
        }

        .del-row {
            color: #ff4444;
        }

        .theme-name:hover .edit-row,
        .theme-name:hover .del-row {
            opacity: 1;
        }

        .push-col {
            width: 60px;
            text-align: center;
            background: #111 !important;
            border-right: 1px solid var(--border);
            position: sticky;
            left: 0;
            z-index: 20;
        }

        /* Ensure cross-section headers stay on top of sticky columns */
        th.push-col,
        th.theme-name {
            z-index: 40;
        }

        .btn-push {
            background: rgba(255, 153, 51, 0.1);
            color: var(--accent);
            border: 1px solid var(--accent);
            padding: 4px 8px;
            font-size: 0.6rem;
            border-radius: 4px;
            font-weight: 800;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
        }

        .btn-push:hover {
            background: var(--accent);
            color: white;
        }

        .btn-push.active {
            background: #44ff44;
            border-color: #44ff44;
            color: #000;
        }

        .color-cell {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.02);
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .color-cell:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .hex-code {
            font-family: 'Courier New', Courier, monospace;
            font-weight: 600;
            font-size: 0.75rem;
        }

        #suggestion-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 600px;
            max-height: 85vh;
            background: #111;
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            z-index: 3000;
            display: none;
            /* Initial hidden state */
            flex-direction: column;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.9);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2500;
        }

        .suggestion-grid {
            display: grid;
            grid-template-columns: 130px repeat(3, 1fr);
            gap: 6px;
            margin-top: 10px;
        }

        .grid-header {
            background: rgba(255, 255, 255, 0.05);
            padding: 5px;
            border-radius: 4px;
            color: var(--accent);
            font-weight: 800;
            text-align: center;
            font-size: 0.6rem;
        }

        /* Custom Scrollbar for Modal Content */
        .modal-scroll-area::-webkit-scrollbar {
            width: 10px;
        }

        .modal-scroll-area::-webkit-scrollbar-thumb {
            background: #00ffff !important;
            /* Bright Cyan for visibility */
            border-radius: 10px;
            border: 2px solid #111;
        }

        .modal-scroll-area::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .modal-scroll-area {
            overflow-y: auto !important;
            scrollbar-width: thin;
            scrollbar-color: #00ffff #222;
        }

        .option-choice {
            background: rgba(255, 255, 255, 0.02);
            padding: 4px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .status-pill {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #44ff44;
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.65rem;
            font-weight: 800;
            display: none;
            z-index: 4000;
        }

        .selection-radio {
            transform: scale(1.2);
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="top-nav">
        <img src="jdroidxlogo.png" alt="jDroid-X Logo" class="logo-jdroidx">
        <div class="theme-selector-container">
            <span style="font-size: 0.7rem; font-weight: 800; color: #666; text-transform: uppercase;">Atmosphere
                Sync:</span>
            <select id="theme-selector" class="theme-select" onchange="applyThemeToDesigner(this.value)">
                <option value="-1">Base Designer Theme</option>
            </select>
        </div>
    </div>

    <div id="status-pill" class="status-pill">CHANGES SAVED</div>

    <h1>Jdroid-X Theme Palette Design System</h1>
    <p>Atmospheric Theme Designer - Active Workflow Mode</p>

    <div class="action-bar" style="justify-content: space-between;">
        <div style="display:flex; gap:10px;">
            <button class="btn-secondary" onclick="window.location.href='digital_clone/PDF Stories/index.html'">View
                Stories</button>
        </div>
        <div style="display:flex; gap:10px;">
            <button class="btn-premium" onclick="openThemeDiscovery()">+ Discover Atmosphere</button>
            <button class="btn-secondary" onclick="addNewElement()">+ Add UI Layer</button>
            <button class="btn-secondary" style="border-color: #44ff44; color: #44ff44;" onclick="syncToWebsite()">↑
                Sync To Website</button>
            <button class="btn-secondary" style="border-color: #33aaff; color: #33aaff;" onclick="syncToPalette()">↓
                Sync To Palette</button>
        </div>
        <button class="btn-reset" onclick="resetData()">Factory Reset</button>
    </div>

    <div class="table-container">
        <table id="palette-table">
            <thead>
                <tr id="header-row">
                    <th class="push-col">Select</th>
                    <th class="theme-name" style="justify-content:center;">Atmosphere Theme</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <footer
        style="margin-top: 50px; padding: 30px; border-top: 1px solid rgba(255,255,255,0.05); width: 100%; display: flex; justify-content: center;">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
            <p
                style="opacity: 0.8; font-size: 0.9rem; font-weight: 700; letter-spacing: 0.05em; color: white; margin: 0;">
                © 2026 jDroid-X • DESIGN SYSTEM MASTER
            </p>
            <span style="font-size: 0.5rem; color: #444; letter-spacing: 0.1em;">BUILD: 2026-02-23 - TRANSPOSED MATRIX
                V2.5</span>
        </div>
    </footer>

    <div id="modal-overlay" class="modal-overlay" onclick="closeModal()"></div>
    <div id="suggestion-modal" style="display: none;">
        <div
            style="color: white; font-weight: 800; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <span id="disc-theme-name" style="font-size: 0.95rem; color: var(--accent);">New Theme</span>
                <div style="font-size: 0.55rem; color: #666; font-weight: 400;">Intelligent matching based on atmosphere
                    keywords</div>
            </div>
            <span
                style="font-size: 0.5rem; color: var(--accent); border: 1px solid var(--accent); padding: 1px 4px; border-radius: 8px;">3-Tier
                Strategy</span>
        </div>

        <!-- Semantic Hue Anchor Bar -->
        <div id="semantic-anchor-container"
            style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; background: rgba(255,255,255,0.03); padding: 4px 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);">
            <div id="semantic-hue-bar"
                style="height: 6px; flex: 1; border-radius: 10px; background: linear-gradient(to right, #f00, #ff0, #0f0, #0ff, #00f, #f0f, #f00); position: relative;">
                <div id="hue-selector-marker"
                    style="position: absolute; top: -4px; width: 14px; height: 14px; background: white; border: 2px solid #000; border-radius: 50%; left: 50%; transform: translateX(-50%); box-shadow: 0 0 10px rgba(0,0,0,0.5);">
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <div id="anchor-color-preview"
                    style="width: 12px; height: 12px; border-radius: 2px; background: #fff; border: 1px solid rgba(255,255,255,0.2);">
                </div>
                <span id="anchor-color-name"
                    style="font-size: 0.6rem; color: #888; text-transform: uppercase; font-weight: 700; width: 60px;">Primary
                    Font</span>
            </div>
        </div>

        <div class="modal-scroll-area"
            style="max-height: 50vh; overflow-y: auto; margin-top: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; padding: 5px; background: rgba(0,0,0,0.3);">
            <div class="suggestion-grid" style="margin-top: 0;">
                <div class="grid-header"
                    style="text-align: left; position: sticky; top: 0; z-index: 10; background: #222;">
                    UI Element</div>
                <div class="grid-header" style="position: sticky; top: 0; z-index: 10; background: #222;"><input
                        type="radio" name="theme-option" value="1" id="rad-1" class="selection-radio" checked> <label
                        for="rad-1">Old School</label></div>
                <div class="grid-header" style="position: sticky; top: 0; z-index: 10; background: #222;"><input
                        type="radio" name="theme-option" value="2" id="rad-2" class="selection-radio"> <label
                        for="rad-2">New School</label></div>
                <div class="grid-header" style="position: sticky; top: 0; z-index: 10; background: #222;"><input
                        type="radio" name="theme-option" value="3" id="rad-3" class="selection-radio"> <label
                        for="rad-3">Ai
                        GenZ</label></div>
                <div id="dynamic-grid" style="display: contents;"></div>
            </div>
        </div>

        <div style="margin-top: 15px; display: flex; gap: 8px;">
            <button class="btn-premium" style="flex: 1;" onclick="applySuggestedTheme()">Save & Add to Website</button>
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Website Connection Modal -->
    <div id="connect-modal"
        style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:95%; max-width:500px; background:#111; border:1px solid var(--accent); border-radius:8px; padding:25px; z-index:3000; box-shadow:0 30px 60px rgba(0,0,0,0.9);">
        <h2 style="color:white; margin:0 0 10px 0; font-size:1.2rem;">Connect to Website</h2>
        <p style="font-size:0.75rem; color:#888; margin-bottom:20px;">Enter the relative path or URL of the target
            website `index.html` to discover its 12-Layer UI Structure.</p>

        <input type="text" id="site-url-input" placeholder="e.g. digital_clone/PDF Stories/index.html"
            style="width:100%; padding:12px; background:#000; border:1px solid #333; color:white; border-radius:5px; margin-bottom:15px; font-family:inherit;">

        <div id="connect-feedback"
            style="display:none; color:#ddd; font-size:0.75rem; margin-bottom:15px; background:rgba(255,153,51,0.1); padding:10px; border-radius:5px; line-height:1.4;">
        </div>

        <div id="fallback-area" style="display:none;">
            <textarea id="manual-code-input" placeholder="Paste HTML or CSS code here..."
                style="width:100%; height:120px; background:#000; border:1px solid #333; color:white; border-radius:5px; margin-bottom:15px; padding:10px; font-family:monospace; font-size:0.7rem; resize:none;"></textarea>
            <button class="btn-premium" style="width:100%; margin-bottom:10px;"
                onclick="processManualContent()">Discover
                Structure from Code</button>
        </div>

        <div style="display:flex; gap:10px;">
            <button id="connect-btn" class="btn-premium" style="flex:1;" onclick="connectToSite()">Connect</button>
            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <script>
        const defaultThemes = []; // Empty to prevent rendering in table
        const rootThemeIdentity = { name: "Default Theme", key: "default", active: true, locked: true };

        const defaultElements = [
            { name: "Main Body BG", role: "Page Backdrop", colors: [] },
            { name: "Sidebar / UI BG", role: "Navigation Rails", colors: [] },
            { name: "Header and Footer", role: "Structural Bars", colors: [] },
            { name: "Action Buttons", role: "Primary Interaction", colors: [] },
            { name: "Primary Accent", role: "Brand Identity", colors: [] },
            { name: "Secondary Accent", role: "Soft Highlights", colors: [] },
            { name: "Primary Font", role: "Content Body", colors: [] },
            { name: "Highlighted Font", role: "Indicators / Titles", colors: [] },
            { name: "UI Border / Divider", role: "Tactical Grid", colors: [] },
            { name: "Card & Tile BG", role: "Content Modules", colors: [] },
            { name: "Scrollbar & Track", role: "Utility Theming", colors: [] },
            { name: "Success / Alert", role: "Status Feedback", colors: [] }
        ];

        let themes = [];
        let elements = [];
        let pendingOptions = null;

        function loadData() {
            const savedThemes = localStorage.getItem('tactiq-matrix-themes');
            const savedElements = localStorage.getItem('tactiq-matrix-elements');
            if (savedThemes && savedElements) {
                themes = JSON.parse(savedThemes).filter(t => t.key !== 'default');
                elements = JSON.parse(savedElements);
            } else {
                // Initialize with TacTiq Teal (Default) as a starting point
                themes = [
                    { name: "TacTiq Teal (Base)", key: "tactiq-teal", active: true, locked: false }
                ];
                elements = [
                    { name: "Main Body BG", role: "Page Backdrop", colors: ["#174C56"] },
                    { name: "Sidebar / UI BG", role: "Navigation Rails", colors: ["#0F353C"] },
                    { name: "Header and Footer", role: "Structural Bars", colors: ["#0F353C"] },
                    { name: "Action Buttons", role: "Primary Interaction", colors: ["#174C56"] },
                    { name: "Primary Accent", role: "Brand Identity", colors: ["#FF9933"] },
                    { name: "Secondary Accent", role: "Soft Highlights", colors: ["#CC7A29"] },
                    { name: "Primary Font", role: "Content Body", colors: ["#FFFFFF"] },
                    { name: "Highlighted Font", role: "Indicators / Titles", colors: ["#FFD700"] },
                    { name: "UI Border / Divider", role: "Tactical Grid", colors: ["#FFFFFF1A"] },
                    { name: "Card & Tile BG", role: "Content Modules", colors: ["#0F353C"] },
                    { name: "Scrollbar & Track", role: "Utility Theming", colors: ["#FF9933"] },
                    { name: "Success / Alert", role: "Status Feedback", colors: ["#44FF44"] }
                ];
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem('tactiq-matrix-themes', JSON.stringify(themes));
            localStorage.setItem('tactiq-matrix-elements', JSON.stringify(elements));
            const pill = document.getElementById('status-pill');
            pill.style.display = 'block';
            setTimeout(() => { pill.style.display = 'none'; }, 2000);
        }

        function resetData() {
            if (confirm("Factory Reset? All custom data will be lost.")) {
                localStorage.clear();
                location.reload();
            }
        }

        function renderTable() {
            const headerRow = document.getElementById('header-row');
            const tbody = document.getElementById('table-body');

            // 1. CLEAR AND PREP HEADERS (Themes are now columns)
            headerRow.innerHTML = `
                <th class="push-col">Mapping</th>
                <th class="theme-name" style="justify-content:center; text-align:center; line-height:1.2;">UI<br>ELEMENT<br>LAYER</th>
            `;

            const selector = document.getElementById('theme-selector');
            const currentVal = selector.value;
            selector.innerHTML = '<option value="-1">Base Designer Theme</option>';

            themes.forEach((theme, themeIdx) => {
                const isPinned = theme.active;

                // Populate Dropdown
                const opt = document.createElement('option');
                opt.value = themeIdx;
                opt.innerText = theme.name;
                selector.appendChild(opt);

                let actionIcons = '';
                if (!theme.locked) {
                    actionIcons = `
                        <div class="row-options" style="margin-top:2px;">
                            <span class="edit-row" onclick="renameTheme(${themeIdx})" title="Rename Theme">✎</span>
                            <span class="del-row" onclick="deleteTheme(${themeIdx})" title="Delete Theme">×</span>
                        </div>
                    `;
                } else {
                    actionIcons = `<div class="row-options" style="margin-top:2px;"><span style="font-size:0.45rem; color:#44ff44; opacity:0.5;">LOCKED</span></div>`;
                }

                const th = document.createElement('th');
                th.style.width = "auto";
                th.style.padding = "4px 12px";
                th.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; gap:3px; padding:4px 0;">
                        <span style="font-size:0.75rem; font-weight:800; color:white;">${theme.name}</span>
                        <button class="btn-push ${isPinned ? 'active' : ''}" onclick="pushTheme(${themeIdx})" style="padding: 2px 6px; font-size: 0.55rem;">
                            ${isPinned ? 'Pinned' : 'Add to Site'}
                        </button>
                        ${actionIcons}
                    </div>
                `;
                headerRow.appendChild(th);
            });

            // 2. RENDER ROWS (Elements are now rows)
            tbody.innerHTML = '';
            const supportedElements = [
                "Main Body BG", "Sidebar / UI BG", "Header and Footer",
                "Action Buttons", "Primary Accent", "Secondary Accent",
                "Primary Font", "Highlighted Font", "UI Border / Divider",
                "Card & Tile BG", "Scrollbar & Track", "Success / Alert"
            ];

            elements.forEach((el, elIdx) => {
                const tr = document.createElement('tr');
                const isSupported = supportedElements.includes(el.name);

                // Cell 1: Mapping Status
                const mappingTd = document.createElement('td');
                mappingTd.className = 'push-col';
                mappingTd.innerHTML = `
                    <div class="sync-indicator ${isSupported ? 'active' : ''}" 
                         onclick="toggleMapping(${elIdx})"
                         title="${isSupported ? 'Perfect Match' : 'Click to Sync'}">
                        ${isSupported ? '✓' : ''}
                    </div>
                `;
                tr.appendChild(mappingTd);

                // Cell 2: Element Identity (Sticky)
                const nameTd = document.createElement('td');
                nameTd.className = 'theme-name';
                nameTd.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <span style="font-size:0.75rem;">${el.name}</span>
                        <span style="font-size:0.45rem; color:#666; font-weight:400; text-transform:uppercase;">${el.role}</span>
                    </div>
                    <span class="del-row" onclick="deleteElement(${elIdx})" style="opacity:0.2; margin-left:10px;">×</span>
                `;
                tr.appendChild(nameTd);

                // Cells 3-N: Colors for each Theme
                themes.forEach((theme, themeIdx) => {
                    const color = el.colors[themeIdx] || "#333333";
                    const td = document.createElement('td');
                    td.style.textAlign = "center";
                    td.innerHTML = `
                        <div class="color-cell" onclick="editColor(${themeIdx}, ${elIdx})" title="Click to change color" style="justify-content:center;">
                            <div class="color-box" style="background: ${color};"></div>
                            <span class="hex-code">${color}</span>
                        </div>
                    `;
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        function editColor(themeIdx, elIdx) {
            const picker = document.createElement('input');
            picker.type = 'color';
            picker.value = elements[elIdx].colors[themeIdx] || "#333333";

            picker.oninput = (e) => {
                const newColor = e.target.value.toUpperCase();
                elements[elIdx].colors[themeIdx] = newColor;

                // Partial render for speed: find every instance of this cell and update
                renderTable();
            };

            picker.onchange = () => {
                saveData(); // Commit to storage
            };

            picker.click();
        }

        function toggleMapping(idx) {
            const supportedElements = [
                "Main Body BG", "Sidebar / UI BG", "Header and Footer",
                "Action Buttons", "Primary Accent", "Secondary Accent",
                "Primary Font", "Highlighted Font", "UI Border / Divider",
                "Card & Tile BG", "Scrollbar & Track", "Success / Alert"
            ];
            const el = elements[idx];
            if (supportedElements.includes(el.name)) {
                alert("✓ COMPOSITE MATCH: This element is already live-mapped to your website's CSS structure.");
                return;
            }

            const choice = prompt(
                `"${el.name}" is a STANDALONE column (not yet controlling visible code).\n\n` +
                `Type a NUMBER to map it to the Website's 12-Layer Structure:\n` +
                `1. Main Body BG\n2. Sidebar / UI BG\n3. Header and Footer\n4. Action Buttons\n5. Primary Accent\n6. Secondary Accent\n7. Primary Font\n8. Highlighted Font\n9. UI Border / Divider\n10. Card & Tile BG\n11. Scrollbar & Track\n12. Success / Alert`
            );

            if (choice) {
                const map = {
                    "1": "Main Body BG", "2": "Sidebar / UI BG", "3": "Header and Footer",
                    "4": "Action Buttons", "5": "Primary Accent", "6": "Secondary Accent",
                    "7": "Primary Font", "8": "Highlighted Font", "9": "UI Border / Divider",
                    "10": "Card & Tile BG", "11": "Scrollbar & Track", "12": "Success / Alert"
                };
                if (map[choice]) {
                    el.name = map[choice];
                    el.role = "Mapped Core Element";
                    saveData(); renderTable();
                }
            }
        }

        function pushTheme(idx) {
            themes[idx].active = !themes[idx].active;
            saveData();
            renderTable();
            if (themes[idx].active) {
                alert(`"${themes[idx].name}" added to website menu! Close this window to return to PDF Stories.`);
            }
        }

        function renameTheme(idx) {
            const currentName = themes[idx].name;
            const newName = prompt(`Enter a new name for the theme "${currentName}":`, currentName);
            if (newName && newName !== currentName) {
                themes[idx].name = toTitleCase(newName);
                saveData();
                renderTable();
            }
        }

        function syncToWebsite() {
            saveData();
            alert("✓ SYNC COMPLETE: Your 12-Layer UI Matrix has been pushed to the website. Refresh PDF Stories to see the atmosphere update.");
        }

        function syncToPalette() {
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('connect-modal').style.display = 'block';
        }

        async function connectToSite() {
            const path = document.getElementById('site-url-input').value.trim();
            const connectBtn = document.getElementById('connect-btn');
            const feedback = document.getElementById('connect-feedback');

            if (!path) {
                alert("Please enter a path or URL.");
                return;
            }

            connectBtn.innerText = "Connecting...";
            feedback.style.display = 'none';

            try {
                const response = await fetch(path);
                if (!response.ok) throw new Error("Could not reach site.");
                const content = await response.text();

                // Determine base path for resolving linked CSS
                let basePath = "";
                if (path.includes('/')) {
                    basePath = path.substring(0, path.lastIndexOf('/') + 1);
                }

                await processStructure(content, basePath);
            } catch (err) {
                console.error(err);
                connectBtn.innerText = "Connect";
                feedback.style.display = 'block';
                feedback.innerHTML = `⚠️ <b>Connection Error:</b> Browsers block reading local disk paths directly.<br><br>Please <b>Paste the Source Code</b> (HTML or CSS) below to manually discover the UI structure:`;
                document.getElementById('fallback-area').style.display = 'block';
            }
        }

        async function processManualContent() {
            const code = document.getElementById('manual-code-input').value;
            if (!code) return alert("Please paste code first.");
            await processStructure(code);
        }

        async function processStructure(content, basePath = "") {
            // Updated Regex to find CSS variables: --name: value
            const varRegex = /--([a-zA-Z0-9-]+)\s*:\s*([^;!]+)/g;
            let match;
            let foundCount = 0;
            let newCount = 0;
            const detectedVars = [];

            // 1. Scrape variables from the current content
            while ((match = varRegex.exec(content)) !== null) {
                const varName = match[1];
                const cleanName = toTitleCase(varName.replace(/-/g, ' '));
                if (!detectedVars.find(v => v.raw === varName)) {
                    detectedVars.push({ name: cleanName, raw: varName, value: match[2].trim() });
                }
            }

            // 2. If HTML, follow linked stylesheets
            if (content.includes('<link') && content.includes('stylesheet')) {
                const linkRegex = /<link[^>]+href=["']([^"']+\.css)["']/g;
                let linkMatch;
                while ((linkMatch = linkRegex.exec(content)) !== null) {
                    const cssUrl = linkMatch[1];
                    try {
                        // Resolve relative URL
                        const targetUrl = basePath + cssUrl;
                        const cssResponse = await fetch(targetUrl);
                        if (cssResponse.ok) {
                            const cssContent = await cssResponse.text();
                            varRegex.lastIndex = 0; // Reset regex
                            while ((match = varRegex.exec(cssContent)) !== null) {
                                const varName = match[1];
                                const cleanName = toTitleCase(varName.replace(/-/g, ' '));
                                if (!detectedVars.find(v => v.raw === varName)) {
                                    detectedVars.push({ name: cleanName, raw: varName, value: match[2].trim() });
                                }
                            }
                        }
                    } catch (e) {
                        console.warn("Could not follow stylesheet:", cssUrl);
                    }
                }
            }

            if (detectedVars.length === 0) {
                alert("No UI structure (CSS variables) found. Tip: Point to the .css file instead of .html, or paste your CSS code directly into the box.");
                return;
            }

            detectedVars.forEach(v => {
                const existingIdx = elements.findIndex(el => el.name.toLowerCase() === v.name.toLowerCase());
                if (existingIdx !== -1) {
                    foundCount++;
                } else {
                    elements.push({
                        name: v.name,
                        role: "Discovered Layer",
                        colors: new Array(themes.length).fill(v.value.startsWith('#') ? v.value : "#333333")
                    });
                    newCount++;
                }
            });

            saveData();
            renderTable();
            closeModal();

            const msg = `✓ STRUCTURE DISCOVERY COMPLETE\n\n` +
                `• ${foundCount} elements mapped to existing structure.\n` +
                `• ${newCount} new architectural layers discovered.\n\n` +
                `Note: Your Designer now reflects the exact live structure of the website.`;
            alert(msg);
        }

        function deleteTheme(idx) {
            if (confirm(`Delete theme "${themes[idx].name}"?`)) {
                themes.splice(idx, 1);
                elements.forEach(el => el.colors.splice(idx, 1));
                saveData(); renderTable();
            }
        }

        function deleteElement(idx) {
            if (confirm(`Delete UI element "${elements[idx].name}"?`)) {
                elements.splice(idx, 1);
                saveData(); renderTable();
            }
        }

        let discoveryHue = 0; // Global tracking for manual overrides

        function openThemeDiscovery() {
            let themeName = prompt("Atmosphere name:", "Cyber Oasis");
            if (!themeName) return;
            themeName = toTitleCase(themeName);
            document.getElementById('disc-theme-name').innerText = themeName;

            // 1. Initial Semantic Detection
            const nameLower = themeName.toLowerCase();
            if (nameLower.includes("red")) discoveryHue = 0;
            else if (nameLower.includes("orange")) discoveryHue = 25;
            else if (nameLower.includes("gold") || nameLower.includes("yellow")) discoveryHue = 48;
            else if (nameLower.includes("green")) discoveryHue = 135;
            else if (nameLower.includes("cyan") || nameLower.includes("teal")) discoveryHue = 185;
            else if (nameLower.includes("blue")) discoveryHue = 215;
            else if (nameLower.includes("purple")) discoveryHue = 275;
            else if (nameLower.includes("pink")) discoveryHue = 335;
            else {
                let tempH = 0;
                for (let i = 0; i < nameLower.length; i++) tempH += nameLower.charCodeAt(i);
                discoveryHue = tempH % 360;
            }

            updateDiscoveryGrid(themeName);
            document.getElementById('modal-overlay').style.display = 'block';
            document.getElementById('suggestion-modal').style.display = 'flex';
        }

        function updateDiscoveryGrid(themeName) {
            pendingOptions = {
                baseName: themeName,
                option1: elements.map(el => generateIntelligentColor(themeName, el.name, 1, discoveryHue)),
                option2: elements.map(el => generateIntelligentColor(themeName, el.name, 2, discoveryHue)),
                option3: elements.map(el => generateIntelligentColor(themeName, el.name, 3, discoveryHue))
            };
            const grid = document.getElementById('dynamic-grid');
            grid.innerHTML = '';
            elements.forEach((el, idx) => {
                const label = document.createElement('div');
                label.style.padding = "5px 10px";
                label.innerHTML = `<span style="color:#aaa; font-size:0.7rem;">${el.name}</span>`;
                grid.appendChild(label);
                [pendingOptions.option1[idx], pendingOptions.option2[idx], pendingOptions.option3[idx]].forEach(val => {
                    const box = document.createElement('div');
                    box.className = 'option-choice';
                    box.innerHTML = `<div class="color-box" style="background: ${val}; width: 22px; height: 22px;"></div><span class="hex-code" style="font-size:0.6rem;">${val}</span>`;
                    grid.appendChild(box);
                });
            });

            // Update UI Tracker
            const marker = document.getElementById('hue-selector-marker');
            const preview = document.getElementById('anchor-color-preview');
            const nameLabel = document.getElementById('anchor-color-name');
            marker.style.left = `${(discoveryHue / 360) * 100}%`;
            preview.style.background = `hsl(${discoveryHue}, 100%, 60%)`;
            nameLabel.innerText = themeName.split(' ')[0];
        }

        // Make Hue Bar Interactive
        document.addEventListener('DOMContentLoaded', () => {
            const hueBar = document.getElementById('semantic-hue-bar');
            if (!hueBar) return;

            const handleHueChange = (e) => {
                const rect = hueBar.getBoundingClientRect();
                let x = e.clientX - rect.left;
                x = Math.max(0, Math.min(x, rect.width));
                discoveryHue = Math.round((x / rect.width) * 360);
                const themeName = document.getElementById('disc-theme-name').innerText;
                updateDiscoveryGrid(themeName);
            };

            hueBar.onmousedown = (e) => {
                handleHueChange(e);
                const moveHandler = (me) => handleHueChange(me);
                const upHandler = () => {
                    window.removeEventListener('mousemove', moveHandler);
                    window.removeEventListener('mouseup', upHandler);
                };
                window.addEventListener('mousemove', moveHandler);
                window.addEventListener('mouseup', upHandler);
            };
        });

        function generateIntelligentColor(themeName, elName, variant, manualHue = null) {
            const name = themeName.toLowerCase();
            let baseH = manualHue !== null ? manualHue : 0;
            let isGrey = false;

            // 1. Semantic Keyword Detection (Only if not manually overridden)
            if (manualHue === null) {
                if (name.includes("grey") || name.includes("gray") || name.includes("stock") || name.includes("silver") || name.includes("slate") || name.includes("metal")) {
                    isGrey = true;
                    baseH = 210; // Cool grey base
                }
                else if (name.includes("red") || name.includes("blood") || name.includes("lava")) baseH = 0;
                else if (name.includes("orange") || name.includes("sunset") || name.includes("tiger")) baseH = 25;
                else if (name.includes("gold") || name.includes("yellow") || name.includes("sun")) baseH = 48;
                else if (name.includes("green") || name.includes("emerald") || name.includes("forest")) baseH = 135;
                else if (name.includes("cyan") || name.includes("teal") || name.includes("aqua") || name.includes("ice")) baseH = 185;
                else if (name.includes("blue") || name.includes("ocean") || name.includes("sky")) baseH = 215;
                else if (name.includes("purple") || name.includes("violet") || name.includes("berry")) baseH = 275;
                else if (name.includes("pink") || name.includes("rose") || name.includes("candy")) baseH = 335;
                else {
                    for (let i = 0; i < name.length; i++) baseH += name.charCodeAt(i);
                    baseH = baseH % 360;
                }
            }

            let h = baseH, s = isGrey ? 5 : 70, l = 50;

            // 2. Structural Role Logic & Bracketing (Comprehensive 12-Layer)
            if (elName.includes("Main Body")) { h = (baseH + 5) % 360; s = isGrey ? 2 : 20; l = 10; }
            else if (elName.includes("Sidebar")) { h = (baseH + 10) % 360; s = isGrey ? 3 : 25; l = 7; }
            else if (elName.includes("Header")) { h = baseH; s = isGrey ? 4 : 40; l = 18; }
            else if (elName.includes("Primary Font")) { s = isGrey ? 0 : 70; l = 92; }
            else if (elName.includes("Button")) { h = baseH; s = isGrey ? 8 : 45; l = 28; }
            else if (elName.includes("Accent")) { h = baseH; s = isGrey ? 15 : 100; l = 60; }
            else if (elName.includes("Secondary Accent")) { h = (baseH + 20) % 360; s = isGrey ? 5 : 50; l = 40; }
            else if (elName.includes("Highlighted")) { h = 45; s = 90; l = 75; }
            else if (elName.includes("Border")) { h = baseH; s = isGrey ? 2 : 15; l = 25; }
            else if (elName.includes("Card")) { h = (baseH + 5) % 360; s = isGrey ? 4 : 22; l = 14; }
            else if (elName.includes("Scrollbar")) { h = baseH; s = isGrey ? 0 : 20; l = 35; }
            else if (elName.includes("Success")) { h = 140; s = 80; l = 45; }

            // 3. Generation Era Logic
            if (variant === 1) { // Old School (Dull / Analog / 70s-90s)
                if (isGrey) {
                    s = 2;
                    if (elName.includes("Accent")) { l = 45; s = 8; }
                    else if (elName.includes("Primary Font")) { l = 70; s = 0; }
                    else if (elName.includes("Button")) { l = 35; }
                } else {
                    s = Math.max(10, s - 30);
                    if (elName.includes("Main Body")) l = 12;
                    else if (elName.includes("Accent")) l = 45;
                }
            }
            else if (variant === 2) { // New School (Glossy / Vibrant / 2020s)
                if (isGrey) {
                    s = 15; h = 215; // Cool Chrome
                    if (elName.includes("Accent")) l = 85;
                    else if (elName.includes("Button")) l = 45;
                    else if (elName.includes("Main Body")) l = 8;
                } else {
                    s = 100; // Max Sensation
                    if (elName.includes("Main Body")) l = 10;
                    else if (elName.includes("Accent")) { l = 65; s = 100; }
                    else if (elName.includes("Button")) { l = 40; h = (baseH - 10) % 360; }
                }
            }
            else { // Ai GenZ (Synthetic / Neon / Futuristic)
                if (isGrey) {
                    if (elName.includes("Main Body")) l = 2;
                    else if (elName.includes("Sidebar")) l = 4;
                    else if (elName.includes("Accent")) { l = 95; s = 0; }
                    else if (elName.includes("Header")) { l = 15; }
                    else if (elName.includes("Button")) { l = 30; }
                } else {
                    s = 100;
                    h = (baseH + 35) % 360;
                    if (elName.includes("Main Body")) { l = 3; h = (baseH + 200) % 360; s = 40; }
                    else if (elName.includes("Sidebar")) { l = 6; h = (baseH + 200) % 360; s = 30; }
                    else if (elName.includes("Header")) { l = 10; h = (baseH + 200) % 360; s = 50; }
                    else if (elName.includes("Accent")) { l = 60; s = 100; h = (baseH + 35) % 360; }
                    else if (elName.includes("Button")) { l = 35; h = (baseH + 75) % 360; s = 80; }
                    else if (elName.includes("Primary Font")) { l = 96; s = 50; h = (baseH + 20) % 360; }
                }
            }

            return hslToHex(h, s, l);
        }

        function toTitleCase(str) {
            return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
        }

        function hslToHex(h, s, l) {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
        }

        function applySuggestedTheme() {
            const selectedOptNum = document.querySelector('input[name="theme-option"]:checked').value;
            const chosenColors = pendingOptions[`option${selectedOptNum}`];

            const prefixes = { "1": "Old", "2": "New", "3": "GenZ" };
            const prefix = prefixes[selectedOptNum];
            const fullName = toTitleCase(`${prefix} ${pendingOptions.baseName}`);

            themes.push({ name: fullName, key: fullName.toLowerCase().replace(/\s/g, '-'), active: true });
            elements.forEach((el, idx) => el.colors.push(chosenColors[idx]));
            saveData(); renderTable(); closeModal();
            alert(`"${fullName}" created and added to website!`);
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('suggestion-modal').style.display = 'none';
            document.getElementById('connect-modal').style.display = 'none';
            document.getElementById('fallback-area').style.display = 'none';
            document.getElementById('connect-feedback').style.display = 'none';
        }

        function addNewElement() {
            const name = prompt("Element Name:"); if (!name) return;
            const role = prompt("Visual Role:"); if (!role) return;
            const formattedName = toTitleCase(name);
            elements.push({ name: formattedName, role: toTitleCase(role), colors: new Array(themes.length).fill("#333333") });
            saveData(); renderTable();
        }

        function exportBlueprint() {
            let blueprint = `/* TACTIQ DESIGN ARCHITECT BLUEPRINT */\n\n`;
            elements.forEach((el, idx) => {
                const varName = el.name.toLowerCase().replace(/ \/ /g, '-').replace(/ & /g, '-').replace(/ /g, '-');
                blueprint += `/* ${el.name} (${el.role}) */\n`;
                themes.forEach((theme, themeIdx) => {
                    blueprint += `--${varName}-${theme.key}: ${el.colors[themeIdx]};\n`;
                });
                blueprint += `\n`;
            });
            navigator.clipboard.writeText(blueprint).then(() => {
                alert("Master Design Blueprint copied to clipboard!\n\nYou can now paste this CSS structure into any new website project.");
            });
        }

        function applyThemeToDesigner(themeIdx) {
            if (themeIdx == -1) {
                // Restore default designer colors
                document.documentElement.style.setProperty('--bg', '#0a0a0a');
                document.documentElement.style.setProperty('--card-bg', '#111');
                document.documentElement.style.setProperty('--accent', '#FF9933');
                return;
            }

            // Map Palette Elements to Designer UI variables
            const theme = themes[themeIdx];

            // Function to find color by element name
            const getColor = (name) => {
                const el = elements.find(e => e.name === name);
                return el ? el.colors[themeIdx] : null;
            };

            const bg = getColor("Main Body BG");
            const cardBg = getColor("Card & Tile BG") || getColor("Sidebar / UI BG");
            const accent = getColor("Primary Accent");

            if (bg) document.documentElement.style.setProperty('--bg', bg);
            if (cardBg) document.documentElement.style.setProperty('--card-bg', cardBg);
            if (accent) document.documentElement.style.setProperty('--accent', accent);
        }

        window.onload = () => { loadData(); renderTable(); };
    </script>
</body>

</html>